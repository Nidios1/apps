name: Build IPA for iOS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true
        
    - name: Install dependencies
      working-directory: ./PPAPIKey_Mobile_Project
      run: flutter pub get
        
    - name: Clean and prepare
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        flutter clean
        flutter pub get
        flutter packages get
        
    - name: Install iOS dependencies
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        cd ios
        pod install --repo-update
        
    - name: Build iOS for Device (Release)
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Building iOS app for device..."
        flutter build ios --release --no-codesign --verbose
        
    - name: Archive iOS App
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Archiving iOS app..."
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/Runner.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        
    - name: Verify Build Contents
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Checking build contents..."
        ls -la build/ios/iphoneos/Runner.app/
        echo "Checking for required files..."
        ls -la build/ios/iphoneos/Runner.app/Frameworks/ || echo "Frameworks folder missing"
        ls -la build/ios/iphoneos/Runner.app/_CodeSignature/ || echo "CodeSignature folder missing"
        
    - name: Create IPA from Archive
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Creating IPA from archive..."
        cd ios
        # Create a temporary ExportOptions without teamID requirement
        cat > temp_export_options.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>development</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath build/Runner.xcarchive \
          -exportPath build/ipa \
          -exportOptionsPlist temp_export_options.plist \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        
        echo "Moving IPA to project root..."
        cp build/ipa/Runner.ipa ../../ppapikey.ipa
        echo "IPA created successfully"
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ppapikey-ipa
        path: PPAPIKey_Mobile_Project/ppapikey.ipa
        retention-days: 30
