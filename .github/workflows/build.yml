name: Build Flutter iOS App (No Signing)

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
        channel: 'stable'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Check Flutter project structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Contents:"
        ls -la
        echo "Looking for pubspec.yaml..."
        find . -name "pubspec.yaml" -type f
        
    - name: Install dependencies
      working-directory: ./PPAPIKey_Mobile_Project
      run: flutter pub get
      
    - name: Run tests
      working-directory: ./PPAPIKey_Mobile_Project
      run: flutter test
      
    - name: Analyze code
      working-directory: ./PPAPIKey_Mobile_Project
      run: flutter analyze
      
    - name: Build iOS Debug (No Code Signing)
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Building iOS app in debug mode without code signing..."
        flutter build ios --debug --no-codesign
        
    - name: Build iOS Release (No Code Signing)
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Building iOS app in release mode without code signing..."
        flutter build ios --release --no-codesign
        
    - name: Build IPA Debug
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Building IPA in debug mode..."
        flutter build ipa --debug --no-codesign
        
    - name: Build IPA Release
      working-directory: ./PPAPIKey_Mobile_Project
      run: |
        echo "Building IPA in release mode..."
        flutter build ipa --release --no-codesign
        
    - name: Upload Debug IPA
      uses: actions/upload-artifact@v4
      with:
        name: ppapikey-mobile-debug-${{ github.sha }}
        path: PPAPIKey_Mobile_Project/build/ios/ipa/*.ipa
        retention-days: 30
        
    - name: Upload Release IPA
      uses: actions/upload-artifact@v4
      with:
        name: ppapikey-mobile-release-${{ github.sha }}
        path: PPAPIKey_Mobile_Project/build/ios/ipa/*.ipa
        retention-days: 30
        
    - name: Upload Debug Build
      uses: actions/upload-artifact@v4
      with:
        name: ppapikey-mobile-debug-build-${{ github.sha }}
        path: PPAPIKey_Mobile_Project/build/ios/iphoneos/
        retention-days: 7
        
    - name: Build Summary
      run: |
        echo "=========================================="
        echo "‚úÖ Build completed successfully!"
        echo "=========================================="
        echo "üì± Debug IPA: ppapikey-mobile-debug-${{ github.sha }}"
        echo "üì± Release IPA: ppapikey-mobile-release-${{ github.sha }}"
        echo "üì± Debug Build: ppapikey-mobile-debug-build-${{ github.sha }}"
        echo "=========================================="
        echo "‚ö†Ô∏è  Note: These IPAs are NOT signed"
        echo "‚ö†Ô∏è  Cannot be installed on real devices"
        echo "‚ö†Ô∏è  For development/testing purposes only"
        echo "‚ö†Ô∏è  Use iOS Simulator for testing"
        echo "=========================================="
