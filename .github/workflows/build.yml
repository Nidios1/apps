name: Build iOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true
        
    - name: Setup CocoaPods
      run: |
        sudo gem install cocoapods
        pod setup
        
    - name: Clean project
      run: |
        flutter clean
        rm -rf ios/Pods
        rm -rf ios/Podfile.lock
        rm -rf build/
        
    - name: Get dependencies
      run: |
        flutter pub get
        
    - name: Generate Flutter iOS files
      run: |
        flutter precache --ios
        
    - name: Install iOS dependencies
      run: |
        cd ios
        pod install --repo-update --verbose
        cd ..
        
    - name: Verify configuration
      run: |
        echo "Bundle ID: com.ppapikey.dev"
        grep -r "com.ppapikey.dev" ios/Runner/
        echo "Checking entitlements..."
        ls -la ios/Runner/Runner.entitlements
        
    - name: Build iOS App (Unsigned)
      run: |
        flutter build ios --release --no-codesign --no-pub --verbose
        
    - name: Verify app structure
      run: |
        echo "App structure:"
        ls -la build/ios/iphoneos/Runner.app/
        echo "Checking Info.plist..."
        plutil -p build/ios/iphoneos/Runner.app/Info.plist | grep -E "(CFBundleIdentifier|CFBundleDisplayName|CFBundleVersion)"
        
    - name: Create IPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ../../../PPAPIKey_Mobile.ipa Payload/ -x "*.DS_Store" "*/.*"
        cd ../../..
        
    - name: Verify IPA
      run: |
        echo "IPA contents:"
        unzip -l PPAPIKey_Mobile.ipa
        echo "IPA size:"
        ls -lh PPAPIKey_Mobile.ipa
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: PPAPIKey_Mobile.ipa
        retention-days: 30
        
    - name: Create installation instructions
      run: |
        cat > INSTALLATION_INSTRUCTIONS.md << 'EOF'
        # PPAPIKey Mobile - Installation Instructions
        
        ## Important Notes
        - This is an UNSIGNED IPA file
        - You need a valid Apple Developer Account to install
        - Device must be registered in your provisioning profile
        
        ## Installation Methods
        
        ### Method 1: Using AltStore (Recommended)
        1. Install AltStore on your Mac/PC
        2. Download the IPA from GitHub Actions artifacts
        3. Connect your iOS device
        4. Drag and drop IPA to AltStore
        5. Enter your Apple ID credentials
        6. Install on device
        
        ### Method 2: Using Sideloadly
        1. Download Sideloadly
        2. Download the IPA from GitHub Actions artifacts
        3. Connect your iOS device
        4. Load IPA in Sideloadly
        5. Enter your Apple ID credentials
        6. Install on device
        
        ### Method 3: Using Xcode
        1. Download Xcode
        2. Download the IPA from GitHub Actions artifacts
        3. Extract IPA contents
        4. Import Runner.app into Xcode
        5. Set your development team
        6. Build and run on device
        
        ## Troubleshooting
        
        ### "Cannot Install" Error
        - Ensure device is registered in Apple Developer Portal
        - Check Bundle ID matches provisioning profile (com.ppapikey.dev)
        - Verify certificate is valid and not expired
        
        ### "Untrusted Developer" Error
        - Go to Settings > General > Device Management
        - Trust the developer certificate
        
        ### "App Installation Failed" Error
        - Check if device has enough storage space
        - Restart device and try again
        - Use a different installation method
        
        ## Bundle Information
        - Bundle ID: com.ppapikey.dev
        - Version: 1.2.2
        - Build: 1
        - iOS Requirement: 13.0+
        EOF
        
    - name: Upload installation instructions
      uses: actions/upload-artifact@v4
      with:
        name: installation-instructions
        path: INSTALLATION_INSTRUCTIONS.md
        retention-days: 30